= 地图组件

`GeoMap` UI 组件展示 xref:maps:layers-sources.adoc[图层] 提供的地理数据。

地图由层叠的图层构建。初始时，地图没有图层。

在视图的 XML 中，可以定义地图的参数以及图层。

[[map]]
== 地图

通过 Jmix Studio 添加地图组件。

点击操作面板中的 *Add Component*，找到 `GeoMap` 并双击。

image::adding-map.png[align="center", width="1136"]

新的 `geoMap` 元素会被添加到 *Jmix UI* 结构面板和 XML 中。可以配置一些属性，如 xref:flow-ui:vc/common-attributes.adoc#id[id]、xref:flow-ui:vc/common-attributes.adoc#height[height]、xref:flow-ui:vc/common-attributes.adoc#width[width] 等，与其他 xref:flow-ui:vc/components.adoc[UI 组件] 类似。

[source,xml,indent=0]
----
<maps:geoMap id="map"
             height="100%"
             width="100%"/>
----

如果不使用视图设计器，可以在视图的 XML 中手动添加 `maps` 命名空间：

[source,xml,indent=0]
----
include::example$/maps-ex2/src/main/resources/com/company/mapssample/view/mapbasic/map-basic-view.xml[tags=xmlns]
----

[[how-to-inject]]
通过 *Jmix UI* 结构面板的 *Inject to Controller* 操作可以将 UI 组件或地图图层注入 Java 控制器。

image::inject-map-from-hierarchy.png[align="center", width="368"]

或者，也可以使用操作面板的 *Inject* 按钮注入：

image::inject-map.png[align="center", width="682"]

NOTE: 对于需要注入控制器的 UI 组件，必须要有 `id` 属性。

现在可以直接以编程的方式与 `GeoMap` 组件交互：

[source,java,indent=0]
----
include::example$/maps-ex2/src/main/java/com/company/mapssample/view/mapbasic/MapBasicView.java[tags=geoMap;onInit]
----

[[layer]]
== 图层

`GeoMap` 组件可以包含多个 xref:maps:layers-sources.adoc[图层]，以展示不同类型的地理信息，例如栅格层、矢量层。

初始时，地图没有任何图层。

示例，我们在地图中添加一个 xref:maps:layers-sources.adoc#tile-layer[瓦片层]。

在 *Jmix UI* 结构面板或视图的 XML 中，选择 `geoMap` 元素，然后点击组件面板的 *Add* 按钮。在下拉框中选择 *Layers -> TileLayer*。

image::add-tile-layer.png[align="center", width="331"]

可以将图层 <<how-to-inject,注入>> 控制器，然后直接以编程的方式与图层交互：

[source,java,indent=0]
----
include::example$/maps-ex2/src/main/java/com/company/mapssample/view/mapbasic/MapBasicView.java[tags=mapTile;onInit]
----

[[source]]
== 数据源

一个 xref:maps:layers-sources.adoc[数据源] 表示用于渲染地图组件中图层的数据。数据源提供的空间信息定义了图层的内容和外观。

示例，我们为瓦片层添加一个 xref:maps:layers-sources.adoc#osm-source[OsmSource]。

在 *Jmix UI* 结构面板或视图的 XML 中，选择 `maps:tile` 元素，然后点击组件面板的 *Add* 按钮。在下拉框中选择 *OsmSource*。

image::add-osmsource.png[align="center", width="898"]

[source,xml,indent=0]
----
include::example$/maps-ex2/src/main/resources/com/company/mapssample/view/mapbasic/map-basic-view.xml[tags=osmSource]
----

You can <<how-to-inject,inject>> a source into the controller and interact with it programmatically by accessing its methods directly:

[source,java,indent=0]
----
include::example$/maps-ex2/src/main/java/com/company/mapssample/view/mapbasic/MapBasicView.java[tags=osmSource;onInit]
----
// You can specify additional parameters:
//
// * `attributions` - information about copyrights and licences that need to be displayed on the map when using data from that source. 更多详情参阅 https://openlayers.org/en/v8.2.0/apidoc/module-ol_source_Source-Source.html[Source^].
// * `cacheSize` - the tile cacheSize. Note, the `cacheSize` attribute is set only at creation time and cannot be changed at runtime. 更多详情参阅 https://openlayers.org/en/v8.2.0/apidoc/module-ol_source_Tile-TileSource.html[TileSource^].
// * `crossOrigin` is used for loaded images. Note, `crossOrigin` is set only at creation time and cannot be changed at runtime. 更多详情参阅 https://openlayers.org/en/v8.2.0/apidoc/module-ol_source_OSM-OSM.html[OSM^].
// * `maxZoom` sets the maximum zoom level. The default value is 42. Note, the `maxZoom` attribute is set only at creation time and cannot be changed at runtime. 更多详情参阅 https://openlayers.org/en/v8.2.0/apidoc/module-ol_source_XYZ-XYZ.html[XYZ^].
// * `opaque` sets whether the layer is opaque. The default value is `true`. Note, the `opaque` attribute is set only at creation time and cannot be changed at runtime. 更多详情参阅 https://openlayers.org/en/v8.2.0/apidoc/module-ol_source_OSM-OSM.html[OSM].
// * `url` sets the URL template. Must include \{x}, \{y} or {-y}, and \{z} placeholders. The default value is `++https://tile.openstreetmap.org/{z}/{x}/{y}.png++`. 更多详情参阅 https://openlayers.org/en/v8.2.0/apidoc/module-ol_source_OSM-OSM.html[OSM^].
// * `wrapX` sets whether the source should be looped along the X coordinate. The default value for `Source` is `false`. Note, the `wrapX` attribute is set only at creation time and cannot be changed at runtime. 更多详情参阅 https://openlayers.org/en/v8.2.0/apidoc/module-ol_source_Source-Source.html[Source^].

[[view]]
== 地图视图

https://openlayers.org/en/v8.2.0/apidoc/module-ol_View-View.html[View^] 定义地图的展示方式，包括中心点、缩放级别、旋转以及投影，设置地图在 UI 加载时的初始状态。

默认情况下，`geoMap` 组件展示一个世界地图，地理中心为 `(0,0)`。

在 *Jmix UI* 结构面板或视图的 XML 中，选择 `geoMap` 元素，然后点击组件面板的 *Add* 按钮。在下拉框中选择 *MapView*。

image::add-map-view.png[align="center", width="372"]

[source,xml,indent=0]
----
include::example$/maps-ex2/src/main/resources/com/company/mapssample/view/mapbasic/map-basic-view.xml[tags=mapView]
----

还可以设置更多参数：

* `centerX` 定义地图初始的纬度。值传给 `org.locationtech.jts.geom.Coordinate` 对象。
* `centerY` 定义地图初始的经度。值传给 `org.locationtech.jts.geom.Coordinate` 对象。
* `maxZoom` - 设置 view 的最大缩放级别。
//The default value is 28. 更多详情参阅 https://openlayers.org/en/v8.2.0/apidoc/module-ol_View-View.html#setMaxZoom[setMaxZoom^].
* `minZoom` - 设置 view 的最小缩放级别。
//The default value is 0. 更多详情参阅 https://openlayers.org/en/v8.2.0/apidoc/module-ol_View-View.html#setMinZoom[setMinZoom^].
* `projection` 值的是地图显示时的坐标参考系。通用的投影有 `EPSG:3857` 和 `EPSG:4326`。默认投影是 https://epsg.io/3857[EPSG:3857^]。可以在内部的 `projection` 元素设置自定义投影。更多详情参阅 https://openlayers.org/en/v8.2.0/apidoc/module-ol_proj_Projection-Projection.html[Projection^]。
* `rotation` - 以弧度为单位设置视图的旋转（顺时针正旋转，0 表示北）。更多详情参阅 https://openlayers.org/en/v8.2.0/apidoc/module-ol_View-View.html#setRotation[setRotation^]。
* `zoom` 定义缩放级别。缩放级别的值从 0 开始，表示层级最高的视图，随着地图拉近放大而增加。

[[extent]]
== 地图范围

https://openlayers.org/en/v8.2.0/apidoc/module-ol_extent.html#~Extent[extent^] 通过坐标设置 <<view,地图视图>> 或特定 <<layer,图层>> 的地理边界，定义地图的可见区域。

地图范围通常由最小值（左上角）和最大值（右下角）坐标值定义，其形式为 [`minX`, `minY`, `maxX`, `maxY`]，表示区域的边界框。

在 *Jmix UI* 结构面板或视图的 XML 中，选择 `mapView` 元素或某个图层，然后点击组件面板的 *Add* 按钮。在下拉框中选择 *Extent*，并按照下面配置 `minX`、`minY`、`maxX` 和 `maxY` 属性。

[source,xml,indent=0]
----
include::example$/maps-ex2/src/main/resources/com/company/mapssample/view/mapbasic/map-basic-view.xml[tags=extent]
----
